<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.27.xsd">

    <changeSet id="05-create-cart-items-table" author="developer">
        <comment>Создание таблицы элементов корзины</comment>

        <createTable tableName="cart_items">
            <!-- Базовые поля -->
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>

            <!-- Поля элемента корзины -->
            <column name="cart_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="product_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="price" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Создание внешних ключей -->
        <addForeignKeyConstraint
                baseTableName="cart_items"
                baseColumnNames="cart_id"
                constraintName="fk_cart_items_cart"
                referencedTableName="carts"
                referencedColumnNames="id"
                onDelete="CASCADE"
                onUpdate="CASCADE"/>

        <addForeignKeyConstraint
                baseTableName="cart_items"
                baseColumnNames="product_id"
                constraintName="fk_cart_items_product"
                referencedTableName="products"
                referencedColumnNames="id"
                onDelete="CASCADE"
                onUpdate="CASCADE"/>

        <!-- Уникальное ограничение: один товар может быть только один раз в корзине -->
        <addUniqueConstraint
                tableName="cart_items"
                columnNames="cart_id, product_id"
                constraintName="uk_cart_items_cart_product"/>

        <!-- Добавляем комментарии -->
        <sql>
            COMMENT ON TABLE cart_items IS 'Элементы корзины (товары в корзине)';
            COMMENT ON COLUMN cart_items.cart_id IS 'ID корзины';
            COMMENT ON COLUMN cart_items.product_id IS 'ID товара';
            COMMENT ON COLUMN cart_items.quantity IS 'Количество товара';
            COMMENT ON COLUMN cart_items.price IS 'Цена товара на момент добавления в корзину';
        </sql>

        <!-- Проверочные ограничения -->
        <sql>
            ALTER TABLE cart_items ADD CONSTRAINT chk_cart_items_quantity_positive
                CHECK (quantity > 0);

            ALTER TABLE cart_items ADD CONSTRAINT chk_cart_items_price_positive
                CHECK (price > 0);
        </sql>
    </changeSet>

</databaseChangeLog>