<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.27.xsd">

    <changeSet id="18-create-product-images-table" author="developer">
        <comment>Создание таблицы для дополнительных изображений товаров</comment>

        <!-- Удаляем старую колонку additional_images из таблицы products -->
        <dropColumn tableName="products" columnName="additional_images"/>

        <!-- Создаем новую таблицу product_images -->
        <createTable tableName="product_images">
            <!-- Базовые поля -->
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>

            <!-- Поля изображения -->
            <column name="product_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="image_url" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="display_order" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="alt_text" type="VARCHAR(200)">
                <constraints nullable="true"/>
            </column>
        </createTable>

        <!-- Создание внешнего ключа -->
        <addForeignKeyConstraint
                baseTableName="product_images"
                baseColumnNames="product_id"
                constraintName="fk_product_images_product"
                referencedTableName="products"
                referencedColumnNames="id"
                onDelete="CASCADE"
                onUpdate="CASCADE"/>

        <!-- Создание индексов -->
        <createIndex tableName="product_images" indexName="idx_product_image_product">
            <column name="product_id"/>
        </createIndex>

        <createIndex tableName="product_images" indexName="idx_product_image_order">
            <column name="display_order"/>
        </createIndex>

        <!-- Добавляем комментарии -->
        <sql>
            COMMENT ON TABLE product_images IS 'Дополнительные изображения товаров';
            COMMENT ON COLUMN product_images.product_id IS 'ID товара';
            COMMENT ON COLUMN product_images.image_url IS 'URL изображения';
            COMMENT ON COLUMN product_images.display_order IS 'Порядок отображения';
            COMMENT ON COLUMN product_images.alt_text IS 'Альтернативный текст для изображения';
        </sql>

        <!-- Установим значение по умолчанию -->
        <sql>
            ALTER TABLE product_images ALTER COLUMN display_order SET DEFAULT 0;
        </sql>
    </changeSet>

</databaseChangeLog>
